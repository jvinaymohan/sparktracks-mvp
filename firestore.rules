rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isParent(parentId) {
      return isAuthenticated() && request.auth.uid == parentId;
    }
    
    function isCoach(coachId) {
      return isAuthenticated() && request.auth.uid == coachId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == 'admin';
    }
    
    // Users collection - users can only read/write their own data
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Coach Profiles collection - PUBLIC READ for marketplace
    // BETA: Very permissive rules for testing - TIGHTEN BEFORE PRODUCTION!
    match /coach_profiles/{coachId} {
      allow read: if true; // Public read for marketplace and public coach pages
      allow create, update: if isAuthenticated(); // Allow any authenticated coach to create/update
      allow delete: if isAuthenticated();
    }
    
    // ALSO support camelCase collection name (code uses this)
    match /coachProfiles/{coachId} {
      allow read: if true; // Public read
      allow create, update, delete: if isAuthenticated(); // Allow authenticated users
    }
    
    // Reviews collection - for coach ratings
    // BETA: Permissive for testing - TIGHTEN BEFORE PRODUCTION!
    match /reviews/{reviewId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated(); // BETA: Allow any authenticated user to delete
    }
    
    // Children/Students collection
    // BETA: Permissive for testing - TIGHTEN BEFORE PRODUCTION!
    match /children/{childId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated(); // BETA: Allow any authenticated user to delete
    }
    
    // Tasks collection
    // BETA: Very permissive for testing - TIGHTEN BEFORE PRODUCTION!
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated(); // BETA: Allow any authenticated user to delete
    }
    
    // Classes collection
    // BETA: Very permissive for testing - TIGHTEN BEFORE PRODUCTION!
    match /classes/{classId} {
      allow read: if true; // PUBLIC READ - anyone can browse classes
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated(); // BETA: Allow any authenticated user to delete
    }
    
    // Enrollments collection
    // BETA: Permissive rules for testing - TIGHTEN BEFORE PRODUCTION!
    match /enrollments/{enrollmentId} {
      // Allow any authenticated user to read enrollments (for now)
      allow read: if isAuthenticated();
      
      // Allow any authenticated user to create enrollments (parents, coaches, students)
      // This enables quick booking flow without complex permission checks
      allow create: if isAuthenticated();
      
      // Allow authenticated users to update/delete their own enrollments
      allow update, delete: if isAuthenticated();
    }
    
    // Bookings collection (alternative to enrollments)
    // BETA: Permissive rules for testing
    match /bookings/{bookingId} {
      allow read, create, update, delete: if isAuthenticated();
    }
    
    // Attendance records
    // BETA: Permissive for testing - TIGHTEN BEFORE PRODUCTION!
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated(); // BETA: Allow any authenticated user to delete
    }
    
    // Updates collection (coach announcements)
    // BETA: Permissive for testing - TIGHTEN BEFORE PRODUCTION!
    match /updates/{updateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated(); // BETA: Allow any authenticated user to delete
    }
    
    // Achievements collection
    match /achievements/{achievementId} {
      allow read: if isAuthenticated() && (
        // Users can read their own achievements
        resource.data.userId == request.auth.uid ||
        // Parents can read their children's achievements
        exists(/databases/$(database)/documents/children/$(resource.data.userId)) &&
        get(/databases/$(database)/documents/children/$(resource.data.userId)).data.parentId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create, update, delete: if isAdmin(); // System-generated only
    }
    
    // Messages collection (coach-parent messaging)
    match /messages/{messageId} {
      allow read: if isAuthenticated() && (
        // Sender or recipient can read
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create: if isAuthenticated() && (
        // Users can send messages as themselves
        request.resource.data.senderId == request.auth.uid
      );
      
      allow update, delete: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // Feedback collection
    match /feedback/{feedbackId} {
      // Allow read if authenticated (admin panel needs this)
      // In production, restrict to admin users only via custom claims
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Any user can submit feedback
      allow update, delete: if isAuthenticated(); // Allow updates for now (restrict to admin in production)
    }
    
    // Roadmap collection (product planning)
    match /roadmap/{roadmapId} {
      allow read: if isAuthenticated(); // Admins can read
      allow create, update, delete: if isAuthenticated(); // Admins can manage
    }
    
    // Release notes collection (version tracking)
    match /releaseNotes/{noteId} {
      allow read: if isAuthenticated(); // Any authenticated user can read
      allow write: if isAuthenticated(); // Admins can write (admin panel + sync script)
    }
    
    // Payments collection
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        // Parents can read their payments
        resource.data.parentId == request.auth.uid ||
        // Coaches can read payments for their classes
        exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
        get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.coachId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create, update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid || 
        isAdmin()
      );
      
      allow delete: if isAdmin();
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

