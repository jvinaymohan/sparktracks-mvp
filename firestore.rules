rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isParent(parentId) {
      return isAuthenticated() && request.auth.uid == parentId;
    }
    
    function isCoach(coachId) {
      return isAuthenticated() && request.auth.uid == coachId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == 'admin';
    }
    
    // Users collection - users can only read/write their own data
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Coach Profiles collection - PUBLIC READ for marketplace
    match /coach_profiles/{coachId} {
      allow read: if true; // Public read for marketplace and public coach pages
      allow create: if isAuthenticated(); // Allow any authenticated user to create
      allow update: if isAuthenticated(); // Allow coaches to update their profiles
      allow delete: if isAuthenticated() && request.auth.uid == coachId;
    }
    
    // Reviews collection - for coach ratings
    match /reviews/{reviewId} {
      allow read: if true; // Public read so anyone can see coach reviews
      allow create: if isAuthenticated(); // Parents can create reviews
      allow update: if isAuthenticated() && resource.data.parentId == request.auth.uid;
      allow delete: if isAuthenticated() && (resource.data.parentId == request.auth.uid || isAdmin());
    }
    
    // Children/Students collection
    match /children/{childId} {
      // Allow read if:
      // - Authenticated user (for now, to allow loading)
      // In production, add more specific rules
      allow read: if isAuthenticated();
      
      // Allow create if authenticated (parent/coach creating child)
      allow create: if isAuthenticated();
      
      // Allow update if:
      // - User is the parent of this child
      // - Or user is the coach who created this student
      // - Or admin
      allow update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        resource.data.get('createdByCoachId', null) == request.auth.uid ||
        isAdmin()
      );
      
      // Allow delete if parent or admin
      allow delete: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // Tasks collection
    match /tasks/{taskId} {
      // Allow read for authenticated users (for now)
      // In production, restrict to parent and assigned child
      allow read: if isAuthenticated();
      
      // Allow create if authenticated (parents creating tasks)
      allow create: if isAuthenticated();
      
      // Allow update if authenticated
      // Parent can update their tasks, child can complete
      allow update: if isAuthenticated();
      
      // Allow delete if authenticated (parent deleting)
      allow delete: if isAuthenticated();
    }
    
    // Classes collection
    match /classes/{classId} {
      allow read: if true; // PUBLIC READ - anyone can browse classes (marketplace feature)
      
      allow create: if isAuthenticated() && (
        // Coaches can create classes
        request.resource.data.coachId == request.auth.uid ||
        // Admin can create
        isAdmin()
      );
      
      allow update: if isAuthenticated() && (
        // Coach can update their own classes
        resource.data.coachId == request.auth.uid ||
        // Admin can update
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (
        resource.data.coachId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // Enrollments collection
    match /enrollments/{enrollmentId} {
      allow read: if isAuthenticated() && (
        // Parents can read enrollments for their children
        resource.data.parentId == request.auth.uid ||
        // Students can read their own enrollments
        resource.data.studentId == request.auth.uid ||
        // Coaches can read enrollments for their classes
        exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
        get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.coachId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create: if isAuthenticated() && (
        // Parents can enroll their children
        request.resource.data.parentId == request.auth.uid ||
        // Coaches can enroll students
        exists(/databases/$(database)/documents/classes/$(request.resource.data.classId)) &&
        get(/databases/$(database)/documents/classes/$(request.resource.data.classId)).data.coachId == request.auth.uid ||
        // Admin can create
        isAdmin()
      );
      
      allow update, delete: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // Attendance records
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated() && (
        // Parents can read attendance for their children
        exists(/databases/$(database)/documents/children/$(resource.data.studentId)) &&
        get(/databases/$(database)/documents/children/$(resource.data.studentId)).data.parentId == request.auth.uid ||
        // Coaches can read attendance for their classes
        exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
        get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.coachId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create, update: if isAuthenticated() && (
        // Coaches can mark attendance for their classes
        exists(/databases/$(database)/documents/classes/$(request.resource.data.classId)) &&
        get(/databases/$(database)/documents/classes/$(request.resource.data.classId)).data.coachId == request.auth.uid ||
        // Admin can manage
        isAdmin()
      );
      
      allow delete: if isAdmin();
    }
    
    // Achievements collection
    match /achievements/{achievementId} {
      allow read: if isAuthenticated() && (
        // Users can read their own achievements
        resource.data.userId == request.auth.uid ||
        // Parents can read their children's achievements
        exists(/databases/$(database)/documents/children/$(resource.data.userId)) &&
        get(/databases/$(database)/documents/children/$(resource.data.userId)).data.parentId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create, update, delete: if isAdmin(); // System-generated only
    }
    
    // Messages collection (coach-parent messaging)
    match /messages/{messageId} {
      allow read: if isAuthenticated() && (
        // Sender or recipient can read
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create: if isAuthenticated() && (
        // Users can send messages as themselves
        request.resource.data.senderId == request.auth.uid
      );
      
      allow update, delete: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // Feedback collection
    match /feedback/{feedbackId} {
      // Allow read if authenticated (admin panel needs this)
      // In production, restrict to admin users only via custom claims
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Any user can submit feedback
      allow update, delete: if isAuthenticated(); // Allow updates for now (restrict to admin in production)
    }
    
    // Roadmap collection (product planning)
    match /roadmap/{roadmapId} {
      allow read: if isAuthenticated(); // Admins can read
      allow create, update, delete: if isAuthenticated(); // Admins can manage
    }
    
    // Release notes collection (version tracking)
    match /releaseNotes/{noteId} {
      allow read: if isAuthenticated(); // Any authenticated user can read
      allow write: if isAuthenticated(); // Admins can write (admin panel + sync script)
    }
    
    // Payments collection
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        // Parents can read their payments
        resource.data.parentId == request.auth.uid ||
        // Coaches can read payments for their classes
        exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
        get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.coachId == request.auth.uid ||
        // Admin can read all
        isAdmin()
      );
      
      allow create, update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid || 
        isAdmin()
      );
      
      allow delete: if isAdmin();
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

